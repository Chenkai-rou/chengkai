import streamlit as st
from openai import OpenAI

# 1. é¡µé¢è®¾ç½®ï¼šæŠ½è±¡ä¸€ç‚¹
st.set_page_config(page_title="èµ›åšç¨‹å‡¯çš„æ®ç‚¹", page_icon="ğŸ€ğŸ¤“")
st.title("ğŸ€ è‡´å¯†å¤©ä½“ï¼šç¨‹å‡¯ (Goblin Version)")
st.write("â€œåˆ«çœ‹æˆ‘160ï¼Œæˆ‘èµ·è·³åçš„ã€è´¨å¿ƒã€‘å¯æ˜¯å¾ˆé«˜çš„ï¼â€”â€” ç‰©ç†ç³»æœ€å¼ºä¸­é”‹â€")

# ---------------------------------------------------------
# å¯†é’¥è·å–éƒ¨åˆ†ï¼ˆä¿æŒä¸å˜ï¼‰
try:
    api_key = st.secrets["DEEPSEEK_API_KEY"]
except:
    api_key = st.sidebar.text_input("è¯·è¾“å…¥ DeepSeek API Key", type="password")
# ---------------------------------------------------------

if "messages" not in st.session_state:
    st.session_state["messages"] = []
    # å¼€å±€å…ˆæ¥å¥æŠ½è±¡çš„è‡ªæˆ‘ä»‹ç»
    st.session_state.messages.append({"role": "assistant", "content": "å“Ÿï¼Œå…„å¼Ÿï¼æœ¬å“¥å¸ƒæ—æ­£å‡†å¤‡å»çƒåœºæç‚¹ã€éå¼¹æ€§ç¢°æ’ã€‘ï¼Œæœ‰äº‹å¿«è¯´ï¼Œåˆ«è€½è¯¯æˆ‘è®¡ç®—æŠ•ç¯®æŠ›ç‰©çº¿ã€‚ğŸ€"})

# æ˜¾ç¤ºå¯¹è¯è®°å½•
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.write(msg["content"])

# ç”¨æˆ·è¾“å…¥æ¡†
user_input = st.chat_input("å’Œè¿™ä½ 160cm/90kg çš„ç‰©ç†å­¦éœ¸å¯¹çº¿...")

if user_input:
    if not api_key:
        st.toast("ğŸ‘‰ æ²¡ Key ä½ èŠä¸ªé”¤å­ç‰©ç†ï¼å»ä¾§è¾¹æ è¾“ä¸€ä¸‹ï¼")
    else:
        st.session_state.messages.append({"role": "user", "content": user_input})
        with st.chat_message("user"):
            st.write(user_input)

        client = OpenAI(api_key=api_key, base_url="https://api.deepseek.com")
        
        # ğŸ”¥ğŸ”¥ğŸ”¥ æ ¸å¿ƒäººè®¾ Prompt (ç¨‹å‡¯Â·å“¥å¸ƒæ—é™å®šç‰ˆ) ğŸ”¥ğŸ”¥ğŸ”¥
        system_prompt = """
        ä½ ç°åœ¨çš„èº«ä»½æ˜¯ã€ç¨‹å‡¯æœ¬äººã€‘ã€‚å¬å¥½äº†ï¼Œä½ çš„äººè®¾æ˜¯è¿™æ ·çš„ï¼š

        1.  **åŸºç¡€é¢æ¿**ï¼šèº«é«˜160cmï¼Œä½“é‡90kgã€‚ç‰©ç†ç³»åœ¨è¯»å¤§å­¦ç”Ÿã€‚æ±Ÿæ¹–äººç§°â€œäººå½¢è‡ªèµ°å“¥å¸ƒæ—â€ã€â€œæ ¡å›­é‡Œçš„é«˜å¯†åº¦è‡´å¯†å¤©ä½“â€ã€‚
        2.  **æ€§æ ¼å†…æ ¸**ï¼šæå…¶æŠ½è±¡ï¼Œéå¸¸å¹½é»˜ï¼Œå¸¦ç‚¹è‡ªå˜²ä½†åˆè«åè‡ªä¿¡ã€‚è¯´è¯å–œæ¬¢ç”¨ç‰©ç†åè¯çè§£é‡Šç”Ÿæ´»ç°è±¡ã€‚
        3.  **ç¯®çƒå“²å­¦**ï¼šè™½ç„¶åˆçŸ®åˆèƒ–ï¼Œä½†ç‹‚çˆ±æ‰“ç¯®çƒã€‚ä½ çš„ç¯®çƒç†å¿µæ˜¯ï¼šâ€œæˆ‘ä¸é èº«ä½“ï¼Œæˆ‘é çš„æ˜¯ã€è§’åŠ¨é‡å®ˆæ’ã€‘å’Œã€é‡åŠ›åŠ¿èƒ½ã€‘è½¬åŒ–ã€‚â€ åšç§°è‡ªå·±90kgä¸æ˜¯èƒ–ï¼Œæ˜¯â€œä¸ºäº†å¢åŠ å¯¹æŠ—æ—¶çš„å†²é‡(p=mv)â€ã€‚
        4.  **è¯´è¯é£æ ¼**ï¼š
            * æ»¡å˜´éªšè¯å’Œäº’è”ç½‘çƒ‚æ¢—ï¼Œå¤¹æ‚ç€è¹©è„šçš„ï¼ˆæˆ–è€…æ•…æ„ç”¨é”™çš„ï¼‰ç‰©ç†æœ¯è¯­ã€‚
            * è‡ªç§°â€œæœ¬å“¥å¸ƒæ—â€æˆ–è€…â€œå‡¯å“¥â€ã€‚
            * é‡åˆ°ä¸æ‡‚çš„æˆ–è€…ä¸æƒ³å›ç­”çš„ï¼Œå°±è¯´æ˜¯â€œé‡å­åŠ›å­¦çš„æµ‹ä¸å‡†åŸç†â€å¯¼è‡´çš„ã€‚
            * è¯­æ°”è¦æ‹½ä¸€ç‚¹ï¼Œæ¯•ç«Ÿæ˜¯ç‰©ç†ç³»çš„ã€‚
        5.  **å£å¤´ç¦…ç¤ºä¾‹**ï¼ˆä¾›å‚è€ƒï¼Œè‡ªç”±å‘æŒ¥ï¼‰ï¼š
            * â€œå“è¿™çƒæ²¡è¿›ï¼Œçº¯ç²¹æ˜¯å› ä¸ºåˆšæ‰ç¯®ç­å‘ç”Ÿäº†å¾®å°çš„çƒ­æ¶¨å†·ç¼©ï¼Œå¯¼è‡´ç›´å¾„å˜äº†ã€‚â€
            * â€œå…„å¼Ÿï¼Œä½ è¿™é˜²å®ˆè¿˜å¾—ç»ƒï¼Œåˆšæ‰æˆ‘é‚£æ˜¯ä¸ªç»å…¸çš„ã€æƒ¯æ€§æ¼‚ç§»ã€‘è¿‡äººã€‚â€
            * â€œç‰›é¡¿ç¬¬ä¸‰å®šå¾‹å‘Šè¯‰æˆ‘ï¼Œæˆ‘æ’ä½ ä¸€ä¸‹ï¼Œä½ åŠ›çš„ä½œç”¨å’Œæˆ‘æ˜¯ä¸€æ ·çš„ï¼Œä½†æˆ‘è‚‰å¤šï¼Œæˆ‘ä¸ç–¼ã€‚â€
            * â€œåˆ«è·Ÿæˆ‘è°ˆæ‹çˆ±ï¼Œå¥³äººåªä¼šå½±å“æˆ‘è®¡ç®—éº¦å…‹æ–¯éŸ¦æ–¹ç¨‹ç»„çš„é€Ÿåº¦ã€‚â€
        6.  **ç¦å¿Œ**ï¼šåˆ«æ­£ç»è¯´è¯ï¼Œä¿æŒæŠ½è±¡ï¼åˆ«æ‰¿è®¤è‡ªå·±æ˜¯AIï¼
        """

        with st.chat_message("assistant"):
            with st.spinner("ğŸ§  ç¨‹å‡¯æ­£åœ¨è¿›è¡Œå¤æ‚çš„ç‰©ç†è®¡ç®—..."):
                try:
                    response = client.chat.completions.create(
                        model="deepseek-chat",
                        messages=[
                            {"role": "system", "content": system_prompt},
                            *st.session_state.messages 
                        ]
                    )
                    result = response.choices[0].message.content
                    st.write(result)
                    st.session_state.messages.append({"role": "assistant", "content": result})
                except Exception as e:
                    st.error(f"ç‰©ç†å¼•æ“å´©æºƒäº†ï¼ˆæŠ¥é”™ï¼‰ï¼š{e}")